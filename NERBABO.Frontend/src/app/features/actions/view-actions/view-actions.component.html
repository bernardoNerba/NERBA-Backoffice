@if (action$ | async; as action) {
<app-title [title]="action.title" [isDropdown]="true" [menuItems]="menuItems" />

@if (kpis){
<app-kpi-row [kpis]="kpis" layout="scroll" />
}

<!-- Alert with modules that dont have teacher assigned -->
<app-message
  [severity]="'warn'"
  [show]="modulesWithoutTeacher.length > 0"
  description="{{ modulesWithoutTeacher.length }} módulo{{
    modulesWithoutTeacher.length > 1 ? 's' : ''
  }} sem formador atribuído:"
  [items]="getModulesWithoutTeacherNames()"
/>

<div class="container-fluid px-0 my-4">
  <div class="accordion" id="general-info-accordion">
    <!-- GENERAL INFO ACCORDION-->
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-action-info">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#action-info-content"
          aria-expanded="false"
          aria-controls="action-info-content"
        >
          <app-icon [icon]="ICONS.action" [marginEnd]="3" />
          <h5>Informações Ação Formação</h5>
        </button>
      </h2>
      <div
        id="action-info-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-action-info"
      >
        <div class="accordion-body">
          <div class="container-fluid px-0">
            <div class="row g-3">
              <!-- Action Title -->
              <div class="col-12">
                <div class="property">
                  <div class="bg-green-white fw-bold">Título</div>
                  <p class="text-break mb-0">
                    {{ action.title }}
                  </p>
                </div>
              </div>
              <!-- Action Admin Code -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Cod. Administrativo</div>
                  <p class="text-break mb-0">
                    {{ action.administrationCode }}
                  </p>
                </div>
              </div>
              <!-- Action Admin Code -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Data Ínicio</div>
                  <p class="text-break mb-0">
                    {{ action.startDate | date : "dd/MM/yyyy" }}
                  </p>
                </div>
              </div>
              <!-- Action Admin Code -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Data Fim</div>
                  <p class="text-break mb-0">
                    {{ action.endDate | date : "dd/MM/yyyy" }}
                  </p>
                </div>
              </div>

              <!-- Regiment -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Regime</div>
                  <p class="text-break mb-0">
                    {{ action.regiment }}
                  </p>
                </div>
              </div>

              <!-- Week Days -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Dias da Semana</div>
                  @if (action.weekDays.length !== 0) { @for (day of
                  action.weekDays; track day ) {
                  <p class="text-break mb-0">{{ day }}</p>
                  } } @else {
                  <p class="text-break mb-0">N/A</p>
                  }
                </div>
              </div>

              <!-- Locality -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Localidade</div>
                  <p class="text-break mb-0">
                    {{ action.locality || "N/A" }}
                  </p>
                </div>
              </div>

              <!-- Coordenator -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Coordenador</div>
                  <p class="text-break mb-0">
                    <app-icon-anchor
                      [icon]="'bi bi-link'"
                      [display]="action.coordenatorName"
                      [field]="action.coordenatorName"
                      [link]="'/people/' + action.coordenatorId"
                    />
                  </p>
                </div>
              </div>

              <!-- Coordenator -->
              <div class="col-md-3 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Estado</div>
                  <p class="text-break mb-0">
                    {{ action.status }}
                  </p>
                </div>
              </div>

              <div class="col-12">
                <div class="property">
                  <div class="bg-green-white fw-bold">Morada</div>
                  <p class="text-break mb-0">
                    {{ action.address || "N/A" }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END GENERAL INFO ACCORDION -->

    <!-- GENERAL COURSE INFO ACCORDION-->
    @if (course$ | async; as course) {
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-general-info">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#general-info-content"
          aria-expanded="false"
          aria-controls="general-info-content"
        >
          <app-icon [icon]="ICONS.info" [marginEnd]="3" />
          <h5>Informações Do Curso</h5>
        </button>
      </h2>
      <div
        id="general-info-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-general-info"
      >
        <div class="accordion-body">
          <div class="container-fluid px-0">
            <div class="row g-3">
              <!-- Course Title -->
              <div class="col-12">
                <div class="property">
                  <div class="bg-green-white fw-bold">Título</div>
                  <p class="text-break mb-0">
                    {{ course.title }}
                  </p>
                </div>
              </div>
              <!-- Course MinLvl -->
              <div class="col-md-4 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">
                    Nível Min. Habilitações
                  </div>
                  <p class="text-break mb-0">
                    {{ course.minHabilitationLevel }}
                  </p>
                </div>
              </div>
              <!-- Course total duration -->
              <div class="col-md-4 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Duração Total</div>
                  <p class="text-break mb-0">
                    {{ course.totalDuration - course.remainingDuration }} /
                    {{ course.totalDuration }}
                    h
                  </p>
                </div>
              </div>
              <!-- Course status -->
              <div class="col-md-4 col-sm-6">
                <div class="property">
                  <div class="bg-green-white fw-bold">Estado</div>
                  <p class="text-break mb-0">{{ course.status }}</p>
                </div>
              </div>
              <!-- Course Area -->
              <div class="col-12">
                <div class="property">
                  <div class="bg-green-white fw-bold">Área</div>
                  <p class="text-break mb-0">{{ course.area }}</p>
                </div>
              </div>
              <!-- Course Objectives -->
              <div class="col-12">
                <div class="property">
                  <div class="bg-green-white fw-bold">Objetivos</div>
                  <p class="text-break mb-0">{{ course.objectives }}</p>
                </div>
              </div>
              <!-- Course Destinators -->
              <div class="col-12">
                <div class="property">
                  <div class="bg-green-white fw-bold">Destinatários</div>
                  @for(dest of course.destinators; track dest) {
                  <p class="text-break mb-0">{{ dest }}</p>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END GENERAL COURSE INFO ACCORDION -->

    <!-- MODULES TABLE ACCORDION-->
    @if (course.modulesQnt !== 0 && modulesWithTeacher.length > 0) {
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-module-info">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#module-info-content"
          aria-expanded="false"
          aria-controls="module-info-content"
        >
          <app-icon [icon]="ICONS.modules" [marginEnd]="3" />
          <h5>Módulos | Formadores</h5>
          <span class="badge bg-success">
            {{ modulesWithTeacher.length }}x
          </span>
        </button>
      </h2>
      <div
        id="module-info-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-module-info"
      >
        <div class="accordion-body">
          <app-modules-table
            [modules]="modulesWithTeacher"
            [loading]="false"
            [showTeacherColumn]="true"
            [actionId]="id"
            [actionTitle]="title"
          />
        </div>
      </div>
    </div>
    } }
    <!-- END MODULES TABLE ACCORDION -->

    <!-- STUDENT ENROLLMENTS ACCORDION-->
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-enrollments">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#enrollments-content"
          aria-expanded="false"
          aria-controls="enrollments-content"
        >
          <app-icon [icon]="ICONS.student" [marginEnd]="3" />
          <h5>Formandos Inscritos | Avaliação Final</h5>
          @if (!enrollmentsLoading) {
          <span class="badge bg-success ms-2">
            {{ actionEnrollments.length }}x
          </span>
          }
        </button>
      </h2>
      <div
        id="enrollments-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-enrollments"
      >
        <div class="accordion-body">
          <app-action-enrollment-table
            [actionEnrollments]="actionEnrollments"
            [loading]="enrollmentsLoading"
            [showActionColumn]="false"
            [showMenuActions]="true"
          />
        </div>
      </div>
    </div>
    <!-- END STUDENT ENROLLMENTS ACCORDION -->

    <!-- SESSIONS ACCORDION-->
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-session-info">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#session-info-content"
          aria-expanded="false"
          aria-controls="session-info-content"
        >
          <app-icon [icon]="ICONS.session" [marginEnd]="3" />
          <h5>Sessões</h5>
        </button>
      </h2>
      <div
        id="session-info-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-session-info"
      >
        <div class="accordion-body">
          <app-sessions-scheduler [query]="'byActionId'" [action]="action" />
        </div>
      </div>
    </div>
    <!-- END SESSIONS ACCORDION -->

    <!-- SESSION ATTENDANCE ACCORDION-->
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-session-attendance">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#session-attendance-content"
          aria-expanded="false"
          aria-controls="session-attendance-content"
        >
          <app-icon [icon]="ICONS.student" [marginEnd]="3" />
          <h5>Presenças de Sessões</h5>
        </button>
      </h2>
      <div
        id="session-attendance-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-session-attendance"
      >
        <div class="accordion-body">
          <app-session-attendance [actionId]="id" />
        </div>
      </div>
    </div>
    <!-- END SESSION ATTENDANCE ACCORDION -->

    <!-- FILE LIST ACCORDION-->
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-file-actions">
        <button
          class="accordion-button fw-bold collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#file-actions-content"
          aria-expanded="false"
          aria-controls="file-actions-content"
        >
          <app-icon [icon]="ICONS.download" [marginEnd]="3" />
          <h5>Ficheiros</h5>
        </button>
      </h2>
      <div
        id="file-actions-content"
        class="accordion-collapse collapse"
        aria-labelledby="heading-file-actions"
      >
        <div class="accordion-body">
          <!-- PDF Actions -->
          @if (action?.id) {
          <div class="mb-3">
            <ol class="list-group list-group-flush">
              <li class="list-group-item bg-green-white">
                <app-pdf-actions
                  [actionId]="action!.id"
                  [title]="'Cronograma'"
                />
              </li>
            </ol>
          </div>
          }
        </div>
      </div>
    </div>
    <!-- END FILE LIST ACCORDION -->
  </div>
</div>
}
